$ErrorActionPreference = 'SilentlyContinue'

$currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if(-not $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)){
    Write-Output "Script not being run with admin permissions, elevating..."
    Start-Process powershell.exe -Verb RunAs -ArgumentList ("-NoExit", ("cd '{0}' ; .\main.ps1" -f $PSScriptRoot))
    exit
}

$process = Get-Process -Name Malwarebytes

if($process) {
    Read-Host "Fully quit Malwarebytes and rerun"
    Read-Host "To full quit Malwarebytes, click the carrot icon (^), right click the Malwarebytes icon, and click `"Quit Malwarebytes`""
    exit
}

Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Cryptography -Name MachineGuid -Value ([guid]::NewGuid().ToString())

Install-Module -Name NtObjectManager
Start-Service -Name TrustedInstaller
$parent = Get-NtProcess -ServiceName TrustedInstaller
New-Win32Process "cmd.exe /c net stop MBAMService" -CreationFlags NewConsole -ParentProcess $parent

Invoke-WebRequest "https://downloads.malwarebytes.com/file/mbst" -OutFile "Support Tool.exe"
Invoke-WebRequest 'https://data-cdn.mbamupdates.com/web/mb5-setup-consumer/MBSetup.exe' -OutFile "Malwarebytes Installer.exe"

Read-Host "Hack applied, run the support tool to fix Malwarebytes since it's finicky"

Read-Host "If the support tool failed to reinstall Malwarebytes, run the downloaded installer (if the download fails, download manually)"

Read-Host "You need to reconfigure your settings as this wipes it"